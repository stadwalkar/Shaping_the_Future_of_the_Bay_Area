---
title: "Final Project"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F, message = F)

```

```{r}
library(tidyverse)
library(censusapi)
library(sf)
library(mapview)
library(tigris)
library(leaflet)
library(tidyr)
library(dplyr)
library(ggplot2)
```
## An Investigation Into Changing Demographics Near Police Stations in San Francisco

Crime in San Francisco has seen a significant rise throughout the Covid-19 pandemic. November 2019 to November 2020 shows a 42% jump in burglaries citywide and 34% uptick in car thefts(1). This coincides with a rise in the homeless population; in 2019 there was an increase of more than 30% over the 2017 count(2). It’s easy to attribute a causal relationship between the two, but that inference may be based more on bias than fact. There are a number of confounding factors that may exacerbate these issues, such as ineffectual policing and increasing home prices. The San Francisco Police budget has steadily increased year over year,(3) yet many of these social inequity problems persist not only in SF but the rest of urban America. These include not only homelessness and crime, but racial profiling by the police, the lack of prosecution for crimes(4) leading to recidivism, and more. 

For my project, I will use San Francisco as an example to explore the relationship between police stations and the demographics of residents nearby. Using census data, I can identify the demographic of those that live within a half mile of a police station and perform an equity analysis. My hypothesis is that most police stations are placed in wealthy areas with highly educated people, to provide a sense of security whereas lower income neighborhoods will have less policing and education, which in turn leads to more crime. 

In 2014, Californians passed Proposition 47 that reclassified nonviolent theft as misdemeanors as long as the stolen goods are worth less than $950(5). That is just one example of decriminalization in San Francisco, which further supports my hypothesis that policing is meant to protect wealthy individuals and is neglected for lower income areas. 

I will then provide a qualitative analysis on whether more or less crime happens in those areas. As stated on sfgov.org, “The Tenderloin Task Force was created on April 1st 1991 (with the first bicycle patrol in the city) to combat the high level of crime in that area and made its headquarters in the basement of the historic Hibernia Bank building. A new headquarters, now formally known as Tenderloin Station, opened in October 2000 at 301 Eddy Street.” The decision to open a police station in this case seems purely motivated by proximity to crime. Analyzing the average income and other predicting factors would inform decisions on where to open new stations in the future. Limitations to this study are any qualitative factors that influence police station construction such as the political landscape at the time, as those cannot be captured in a quantitative analysis. A brief commentary will however be provided on factors to consider and potential biases in addition to a data driven approach. 

I will be using ArcGIS Police Station Data, 2020 Decennial Census Data and ACS 2019 5 year data to perform my analysis.


1. https://sfist.com/2020/12/16/burglaries-arsons-and-car-thefts-are-all-up-significantly-in-sf-over-last-year/
2. https://sfgov.org/scorecards/safety-net/homeless-population
3. https://www.sanfranciscopolice.org/sites/default/files/Documents/PoliceCommission/Police%20Commission020718-BudgetPresentationFY2018-2019.pdf
4. https://www.sfexaminer.com/news/data-shows-chesa-boudin-prosecutes-fewer-shoplifters-than-predecessor/
5. https://thehill.com/opinion/criminal-justice/559465-the-little-things-are-turning-san-francisco-bad-in-a-big-way


The following is a map of police stations in San Francisco. We will ignore the SF airport police station and focus on the city limits. 

```{r message = FALSE}

sf_police_new <- read_csv("Local_Law_Enforcement_Locations.csv")

filtered <- filter(
  sf_police_new,
  STATE %in%
    c(
      "CA"
      )
)

filtered <- filter(
  filtered,
  CITY %in%
    c(
      "SAN FRANCISCO"
      )
)

sf_police_map_new <- st_as_sf(filtered, coords = c('LONGITUDE', 'LATITUDE'),crs = 4326)

mapview(sf_police_map_new)
```

```{r}
buffer <- sf_police_map_new %>% 
  st_transform(26910) %>% 
  st_buffer(800) %>% 
  st_transform(4269)

```

```{r}
sf_cbgs <- block_groups("CA", "San Francisco", progress_bar = F)


sf_police_within_halfmile <- sf_cbgs %>% 
  st_centroid() %>% 
  .[buffer, ]


sf_cbgs_police <- sf_cbgs %>% 
  mutate(
    within_halfmile_police_station = ifelse(
      GEOID %in% sf_police_within_halfmile$GEOID,
      1,
      0
    )
  )
```


```{r}
sf_cbgs_police <- sf_cbgs %>% 
  mutate(
    within_halfmile_police_station = ifelse(
      GEOID %in% sf_police_within_halfmile$GEOID,
      1,
      0
    )
  )

```

```{r}
police_filtered <- sf_cbgs_police %>% 
  select(c(GEOID,geometry,within_halfmile_police_station))
```

```{r}
police_filtered <- police_filtered[police_filtered$within_halfmile_police_station !=0,]
```




```{r}

Sys.setenv(CENSUS_KEY="c8aa67e4086b4b5ce3a8717f59faa9a28f611dab")

acs_vars_2019_5yr <-
  listCensusMetadata(
    name = "2019/acs/acs5",
    type = "variables"
  )

dec_vars_2020 <-
  listCensusMetadata(
    name = "2020/dec/pl",
    type = "variables"
  )

smc_pop_race_2020 <-
  getCensus(
    name = "acs/acs5",
    vintage = 2019,
    region = "block group: *", 
    regionin = "state:06+county:075",
    vars = "group(B01001)"
  ) %>%
  mutate(
    GEOID =
      paste0(state,county,tract,block_group)
  ) %>% 
  select(!c(GEO_ID,state,county,tract,block_group,NAME) & !ends_with(c("EA","MA","M"))) %>%
  pivot_longer(
    ends_with("E"),
    names_to = "variable",
    values_to = "estimate"
  ) %>%
  left_join(
    acs_vars_2019_5yr %>% 
      select(name, label), 
    by = c("variable" = "name")
  ) %>% 
  select(-variable) %>% 
  separate(
    label,
    into = c(NA,NA,"sex","age"),
    sep = "!!"
  ) %>% 
  filter(!is.na(age))
```

These are the blocks that are within half a mile of a police station. There appears to be a large gap in the Northwest and South Central parts of the city in terms of police coverage. These are historically wealthier areas, such as Presidio, Sunset, and Cow Hollow.
```{r}
combined <- left_join(police_filtered, smc_pop_race_2020, by = c("GEOID")) 
```

```{r}
combined_test <- combined %>%
  group_by(GEOID, age) %>% 
  summarize(estimate = sum(estimate)) 
```

```{r}
mapview(combined_test)
```

```{r}
perc_of_people <- 
  combined %>% 
  mutate(
    young = 
      ifelse(
        age %in% c(
          "18 and 19 years",
          "20 years",
          "21",
          "22 to 24 years",
          "25 to 29 years",
          "30 to 34 years"
        ),
        estimate,
        NA
      )
  ) %>% 
  group_by(GEOID) %>% 
  summarize(
    young = sum(young, na.rm = T),
    total_pop = sum(estimate, na.rm = T)
  ) %>% 
  mutate(
    between_18_and_34 = young/total_pop*100
  ) %>% 
  filter(!is.na(between_18_and_34))
```
This is a map of the percentage of people near police stations who are between 18 to 34 years of age. 

According to a 2013 city report:

"Younger adults are the most likely age group to be incarcerated," the report states. "In San Francisco, 52 percent of inmates are between the ages of 18 and 35.

https://www.sfgate.com/bayarea/article/S-F-jail-inmates-56-black-4744799.php

This map shows that police stations are close to blocks that range from 3-80% of people who are young. Now let's look at the demographics of people in this area (excluding age).
```{r}
mapview(perc_of_people, zcol = "between_18_and_34")
```

```{r}
census_race_categories <- 
  c(
    "White Alone",
    "Black or African American",
    "American Indian and Alaska Native Alone",
    "Asian Alone",
    "Native Hawaiian and Other Pacific Islander Alone",
    "Some Other Race Alone",
    "Two or More Races"
  )

bay_income_race <-
  1:7 %>% 
  map_dfr(function(x){
     getCensus(
    name = "acs/acs5",
    vintage = 2019,
    region =  "block group: *", 
    regionin = "state:06+county:075",
    vars = paste0("group(C23002",LETTERS[x],")")
    ) %>%
       mutate(
    GEOID =
      paste0(state,county,tract,block_group)
  ) %>% 
  select(!c(GEO_ID,state,county,tract,block_group,NAME) &
   !ends_with(c("EA","MA","M"))) %>%
      pivot_longer(
        ends_with("E"),
        names_to = "name",
        values_to = "estimate"
      ) %>%
      left_join(
        acs_vars_2019_5yr %>% 
          select(name, label)
      ) %>% 
      select(-name) %>% 
      separate(
        label,
        into = c(NA,NA,"income"),
        sep = "!!"
      ) %>% 
      
      
      filter(!is.na(income)) %>% 
      mutate(race = census_race_categories[x])
  })
```




```{r}
bay_income_race <- left_join(police_filtered, bay_income_race, by = c("GEOID")) 
```




Next I used decennial data to find demographics of people Who live close to a police station. This analysis is focused on individuals who are of one race and not mixed. 

```{r}
smc_pop_2020 <-
  getCensus(
    name = "dec/pl",
    vintage = 2020,
    region = "block:*", 
    regionin = "state:06+county:075",
    vars = "P1_001N"
  ) %>% 
  transmute(
    block =
      paste0(state,county,tract,block),
    pop = P1_001N
  )
```

```{r}
smc_pop_2020_original <-
  getCensus(
    name = "dec/pl",
    vintage = 2020,
    region = "block:*", 
    regionin = "state:06+county:075",
    vars = "P1_001N"
  ) 
```


```{r}
smc_pop_race_2020 <-
  getCensus(
    name = "dec/pl",
    vintage = 2020,
    region = "block:*", 
    regionin = "state:06+county:075",
    vars = "group(P1)"
  ) %>% 
  mutate(
    block =
      paste0(state,county,tract,block)
  ) %>% 
  select(!c(GEO_ID,state,county,tract,NAME) & !ends_with(c("NA"))) %>% 
  pivot_longer(
    ends_with("N"),
    names_to = "name",
    values_to = "estimate"
  ) %>%
  left_join(
    dec_vars_2020 %>% 
      select(name, label)
  ) %>% 
  select(-name) %>% 
  separate(
    label,
    into = c(NA,NA,NA,"race"),
    sep = "!!"
  )
```

```{r}
smc_pop_race_2020 <- smc_pop_race_2020 %>% 
  filter(
    race %in% c("White alone", "Black or African American alone", "American Indian and Alaska Native alone", "Asian alone")
  )
```


```{r}
blocks_2020 <- blocks("CA", "San Francisco", year = 2020, progress_bar = F)
```


```{r}

   nfo_boundary <- places("CA", progress_bar = F) %>%
    filter(NAME == "San Francisco")


smc_pop_race_2020 <- smc_pop_race_2020 %>% 
  left_join(blocks_2020 %>% select(block = GEOID20)) %>% 
  st_as_sf() %>% 
  st_centroid() %>% 
  .[nfo_boundary, ] %>% 
  st_drop_geometry() %>% 
  left_join(blocks_2020 %>% select(block = GEOID20)) %>% 
  st_as_sf()
```

```{r}
smc_pop_filtered <- smc_pop_race_2020 %>%
    st_centroid() %>%
  .[police_filtered, ]
```
The following chart shows that it is mostly White and Asian Americans who live close to a police station. Next let's look at the income and education of these people.


```{r}
smc_pop_filtered %>% 
  group_by(estimate, race) %>% 
  summarize(estimate = sum(estimate)) %>% 
  ggplot() +
  geom_bar(
    aes(
      x = race,
      y = estimate,
      fill = race
    ),
    stat = "identity",
    position = "stack"
  ) +
  labs(
    x = "Household income",
    y = "Number of people ",
    title = "Demographics of people that live close to a police station",
    fill = "Race of householder"
  ) +
  coord_flip() +
  theme(
    legend.position = "bottom",
    legend.direction = "vertical"
  )  +
  guides(
    fill = guide_legend(
      reverse = T
    )
  )
```

Income data is not available on the block level for the decennial/acs data sets. I am instead using acs tract level data. Below is a map of these tracts. 



```{r}
ca_tracts <- tracts("CA", cb = T, progress_bar = F)
ca_cities <- places("CA", cb = T, progress_bar = FALSE)
bay_county_names <-
  c(
    "San Francisco"
  )
bay_counties <-
  counties("CA", cb = T, progress_bar = F) %>%
  filter(NAME %in% bay_county_names)



bay_cities <- ca_cities[bay_counties, ]


bay_tracts_within <-
  ca_tracts %>% 
  st_centroid() %>% 
  .[police_filtered, ] %>% 
  st_drop_geometry() %>% 
  left_join(ca_tracts %>% select(GEOID)) %>% 
  st_as_sf()

mapview(bay_tracts_within)
```



```{r}


colnames(ca_tracts)[3]<-"tract"

bay_education_income_tract <- 
  getCensus(
    name = "acs/acs5",
    vintage = 2019,
    region = "tract:*",
    regionin = "state:06+county:075",
    vars = c(
      "B06009_001E",
      "B06009_002E",
      "B06009_003E",
      "B19001_001E",
      "B19001_014E",
      "B19001_015E",
      "B19001_016E",
      "B19001_017E"
    )
) %>% 
  left_join(ca_tracts %>% select(tract,GEOID)
  
)


combined_1 <- left_join(bay_education_income_tract, bay_tracts_within, by = c("GEOID","geometry")) 

combined_1 <- combined_1[!is.na(combined_1$TRACTCE),]


 
```
```{r}

comb <- combined_1 %>% 
  transmute(
    tract = paste0(state, county, tract),
    perc_college = 1 - (B06009_002E + B06009_003E) / B06009_001E,
    perc_over100k = (B19001_014E + B19001_015E + B19001_016E + B19001_017E) / B19001_001E
  ) %>% 
  filter(
    !is.na(perc_college), 
    !is.na(perc_over100k)
  )

```

The following is a regression analysis on the correlation between percentage of people who go to college and the percentage of people who make over $100k per year. 

```{r}
ggplot() +
  geom_point(
    data = comb,
    aes(
      x = perc_college,
      y = perc_over100k
    )
  )
```
```{r}
ggplot(
  data = comb,
  aes(
      x = perc_college,
      y = perc_over100k
    )
) +
  geom_point() +
  geom_smooth(method = "lm") 
```



```{r}
boom <- lm(perc_over100k ~ perc_college, comb)
```



```{r}
 plot(density(residuals(boom)))
```

```{r}
summary(boom)
```
From the information above it seems like the residual plot is not significantly skewed. The r value is 0.496 meaning that variation in college explains 49.6% of the variation in income. 

Below I have applied a log transformation for illustration purposes only. It does not appear to be adequate for the data used. 

```{r}
log_model <- lm(log(perc_over100k) ~ perc_college, comb)
plot(density(residuals(log_model)))

```

```{r}
summary(log_model)
```
Correlation between income, college, and demographics were explored in this report. The Black population in San Francisco is over represented in jail as a result of over policing. They typically live closer to police stations and make up a larger portion of the lower income households. Something interested from this study is that more wealthy areas don't have police stations, such as Cow Hollow, etc., mentioned earlier. This goes against my initial hypothesis.

It appears that income and college are correlated by statistical significance. What we can learn from this study is that increasing access to education, can lead to increased income, and potentially lower crime. When making policy recommendations to increase education, it is important to be as objective as possible and be aware of biases. College may not be the best form of education given it's cost prohibitive. Vocational school may yield similar results. Assuming that only black people suffer is also something to be aware of. Education is something that should be accessible to all people. 

Overall it can be inferred that police stations are placed in areas where there is more crime, and one potential solution is to provide more education to the residents in those areas. 


