---
title: "Assignment 2"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F, message = F)
```

## Question 1

Unfortunately I do not have a plot to show. There was a plot when I was trying with an incorrect method of obtaining the correct geography but that is not included here. I believe I will need the helper code to finish it up. 

One caveat is that the geographical area section cut for 2010 and 2020 is not the exact same. This might skew data slightly as areas will be included or excluded depending on the year. 

Strictly looking at the data it is hard to make a determination on how the population migrates and the density of the area, however I do see certain blocks dramatically increase in area and other blocks dramatically decrease. This is a very desirable neighborhood with the median home being around $1.2 million. It is also very safe with great schools around. It is unsurprising that certain blocks see more inhabitants. The reason why people move might be take advantage of the home prices. At the sky high rates, homes might not be selling fast or they might be bought by developers to add commercial units, thus decreasing population numbers further.      



Please note there is a lot of working code that is commented out as well. 

```{r}
library(tidyverse)
library(sf)
library(censusapi)
library(mapview)
library(leaflet)
library(devtools)
install_github('walkerke/tigris')
library(tigris)
library(here)
library(dplyr)
```


<!-- # Collect 2020 decennial data -->

```{r}
Sys.setenv(CENSUS_KEY="6b3fccc7aab7b5e8476641264fdd46337fb45dfe")

smc_pop_2020 <-
  getCensus(
    name = "dec/pl",
    vintage = 2020,
    region = "block:*", 
    regionin = "state:06+county:081",
    vars = "P1_001N"
  ) %>% 
  transmute(
    block =
      paste0(state,county,tract,block),
    pop = P1_001N
  )

```

<!-- # Collect 2010 decennial data -->

```{r}

smc_pop_2010 <-
  getCensus(
    name = "dec/pl",
    vintage = 2010,
    region = "block:*", 
    regionin = "state:06+county:081",
    vars = "P001001"
  ) %>% 
  transmute(
    block =
      paste0(state,county,tract,block),
    pop = P001001
  )

```


<!-- #Shape file blocks for 2020 and nfo boundary -->
```{r}
smc_blocks_2020 <- blocks("CA", "San Mateo", year = 2020, progress_bar = F)

nfo_boundary <- places("CA", progress_bar = F) %>% 
  filter(NAME == "North Fair Oaks")

nfo_pop_2020 <- smc_pop_2020 %>% 
  left_join(smc_blocks_2020 %>% select(block = GEOID20)) %>% 
  st_as_sf() %>% 
  st_centroid() %>% 
  .[nfo_boundary, ] %>% 
  st_set_geometry(NULL) %>% 
  left_join(smc_blocks_2020 %>% select(block = GEOID20)) %>% 
  st_as_sf()

```


<!-- #Shape file blocks for 2010 and nfo boundary -->
```{r}
smc_blocks_2010 <- blocks("CA", "San Mateo", year = 2010, progress_bar = F)

nfo_boundary <- places("CA", progress_bar = F) %>% 
  filter(NAME == "North Fair Oaks")

nfo_pop_2010 <- smc_pop_2010 %>% 
  left_join(smc_blocks_2010 %>% select(block = GEOID10)) %>% 
  st_as_sf() %>% 
  st_centroid() %>% 
  .[nfo_boundary, ] %>% 
  st_set_geometry(NULL) %>% 
  left_join(smc_blocks_2010 %>% select(block = GEOID10)) %>% 
  st_as_sf()

```


<!-- # Separate data 2020 -->
```{r}

  dec_vars_2020 <-
    listCensusMetadata(
      name = "2020/dec/pl",
    type = "variables"
  )

```

<!-- # Separate data 2010 -->
```{r}
dec_vars_2010 <-
  listCensusMetadata(
    name = "2010/dec/pl",
    type = "variables"
  )
```


<!-- # Bracket based spatial filtering -->

```{r}
smc_blocks_1 <- smc_blocks_2020 %>% 
  select(block = GEOID20) %>% 
  left_join(smc_pop_2020)

sum(smc_blocks_1$pop)
```

```{r}
smc_blocks_2 <-
  smc_blocks_1 %>% 
  st_centroid() %>% 
  .[smc_blocks_2010, ] %>% 
  st_set_geometry(NULL) %>% 
  left_join(smc_blocks_1 %>% select(block)) %>% 
  st_as_sf()

sum(smc_blocks_2$pop)
```



```{r}
smc_blocks_area <-
  nfo_pop_2020 %>% 
  st_transform(26910) %>% 
  mutate(area = st_area(.))

```

```{r}
smc_blocks_intersection <-
  smc_blocks_area %>% 
  st_intersection(
    nfo_pop_2010 %>% 
      st_transform(26910)
  )
```



```{r}
smc_blocks_3 <-
  smc_blocks_2020  %>% 
  select(block = GEOID20) %>% 
  left_join(smc_pop_2020) %>% 
  st_transform(26910) %>% 
  mutate(original_area = st_area(.)) %>% 
  st_intersection(
    nfo_pop_2010 %>% 
      st_transform(26910)
  ) %>% 
  mutate(
    leftover_area = st_area(.),
    perc_area = leftover_area / original_area,
    pop = pop * perc_area
  )
```

```{r}
sum(smc_blocks_3$pop) %>% round()
```

<!-- ```{r} -->
<!-- smc_blocks_3 -->
<!--   smc_blocks_area %>%   -->
<!--   mutate(density = pop.1/leftover_area *0.000247105)  -->
<!-- ``` -->


<!-- # ```{r} -->
<!-- # mapview(smc_blocks_3, zcol = "density") -->
<!-- # ``` -->



<!-- ```{r} -->
<!-- nfo_pop_2010 <- -->
<!--   nfo_pop_2010 %>%  -->
<!--   st_centroid() %>%  -->
<!--   .[nfo_pop_2020, ] %>%  -->
<!--   st_set_geometry(NULL) %>%  -->
<!--   left_join(nfo_pop_2010 %>% select(block)) %>%  -->
<!--   st_as_sf() -->

<!-- sum(nfo_pop_2010$pop) -->

<!-- ``` -->


<!-- ```{r} -->
<!-- nfo_pop_2020 <- nfo_pop_2020 %>%  -->
<!--   st_centroid() %>%  -->
<!--   .[nfo_pop_2010, ] %>%  -->
<!--   st_set_geometry(NULL) %>%  -->
<!--   left_join(nfo_pop_2020 %>% select(block)) %>%  -->
<!--   st_as_sf()  -->

<!-- sum(nfo_pop_2020$pop) -->

<!-- ``` -->




<!-- ```{r} -->
<!-- smc_blocks_area <- -->
<!--   nfo_pop_2020 %>%  -->
<!--   st_transform(26910) %>% -->
<!--   mutate(area = st_area(.)) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- smc_blocks_area <- -->
<!--   smc_blocks_area %>%  -->
<!--   mutate(density = pop/area *0.000247105) %>% -->
<!--   cbind() -->

<!-- ``` -->





<!-- ```{r} -->
<!-- mapview(smc_blocks_area, zcol = "density") -->
<!-- ``` -->


<!-- ```{r} -->
<!-- mapview(nfo_pop_2010, zcol = "pop") -->
<!-- ``` -->





<!--   # Separate data 2020 -->
<!--   ```{r} -->
<!--   dec_vars_2020 <- -->
<!--     listCensusMetadata( -->
<!--       name = "2020/dec/pl", -->
<!--     type = "variables" -->
<!--   ) -->

<!-- smc_pop_race_2020 <- -->
<!--   getCensus( -->
<!--     name = "dec/pl", -->
<!--     vintage = 2020, -->
<!--     region = "block:*",  -->
<!--     regionin = "state:06+county:081", -->
<!--     vars = "group(P1)" -->
<!--   ) %>%  -->
<!--   mutate( -->
<!--     block = -->
<!--       paste0(state,county,tract,block) -->
<!--   ) %>%  -->
<!--   select(!c(GEO_ID,state,county,tract,NAME) & !ends_with(c("NA"))) %>%  -->
<!--   pivot_longer( -->
<!--     ends_with("N"), -->
<!--     names_to = "name", -->
<!--     values_to = "estimate" -->
<!--   ) %>% -->
<!--   left_join( -->
<!--     dec_vars_2020 %>%  -->
<!--       select(name, label) -->
<!--   ) %>%  -->
<!--   select(-name) %>%  -->
<!--   separate( -->
<!--     label, -->
<!--     into = c(NA,NA,"category1","category2"), -->
<!--     sep = "!!" -->
<!--   ) -->
<!-- ``` -->


<!-- # Separate data 2010 -->
<!-- ```{r} -->
<!-- dec_vars_2010 <- -->
<!--   listCensusMetadata( -->
<!--     name = "2010/dec/pl", -->
<!--     type = "variables" -->
<!--   ) -->

<!-- smc_pop_race_2010 <- -->
<!--   getCensus( -->
<!--     name = "dec/pl", -->
<!--     vintage = 2010, -->
<!--     region = "block:*",  -->
<!--     regionin = "state:06+county:081", -->
<!--     vars = "group(P1)" -->
<!--   ) %>%  -->
<!--   mutate( -->
<!--     block = -->
<!--       paste0(state,county,tract,block) -->
<!--   ) %>%  -->
<!--   select(!c(GEO_ID,state,county,tract,NAME) & !ends_with(c("NA"))) %>%  -->
<!--   pivot_longer( -->
<!--     ends_with("N"), -->
<!--     names_to = "name", -->
<!--     values_to = "estimate" -->
<!--   ) %>% -->
<!--   left_join( -->
<!--     dec_vars_2010 %>%  -->
<!--       select(name, label) -->
<!--   ) %>%  -->
<!--   select(-name) %>%  -->
<!--   separate( -->
<!--     label, -->
<!--     into = c(NA,NA,"category1","category2"), -->
<!--     sep = "!!" -->
<!--   ) -->
<!-- ``` -->



<!-- ```{r} -->
<!-- dec_vars_2020 %>%  -->
<!--   filter(grepl("P1",name)) %>%  -->
<!--   select(name, label) %>%  -->
<!--   arrange(name) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- smc_pop_race_2020 <- smc_pop_race_2020 %>%  -->
<!--   mutate( -->
<!--     race = case_when( -->
<!--       category1 == "Population of two or more races:" & is.na(category2) ~ "Two or more races", -->
<!--       category1 == "Population of two or more races:" ~ "", -->
<!--       !is.na(category2) ~ category2, -->
<!--       TRUE ~ "" -->
<!--     ) -->
<!--   ) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- smc_pop_race_2020 <- smc_pop_race_2020 %>%  -->
<!--   filter(race != "") %>%  -->
<!--   select(block, race, pop = estimate) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- smc_blocks_2020 <- blocks("CA", "San Mateo", year = 2020, progress_bar = F) -->

<!-- nfo_boundary <- places("CA", progress_bar = F) %>%  -->
<!--   filter(NAME == "North Fair Oaks") -->

<!-- nfo_pop_2020 <- smc_pop_2020 %>%  -->
<!--   left_join(smc_blocks_2020 %>% select(block = GEOID20)) %>%  -->
<!--   st_as_sf() %>%  -->
<!--   st_centroid() %>%  -->
<!--   .[nfo_boundary, ] %>%  -->
<!--   st_set_geometry(NULL) %>%  -->
<!--   left_join(smc_blocks_2020 %>% select(block = GEOID20)) %>%  -->
<!--   st_as_sf() -->
<!-- ``` -->


<!-- ```{r} -->
<!-- mapview(nfo_pop_2020, zcol = "pop") -->
<!-- ``` -->


