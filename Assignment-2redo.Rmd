---
title: "Sahil_A2"
output:
  html_document:
    df_print: paged
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F, message = F)
```


## Looking at the absolute density difference between 2010 and 2020 I noticed a huge spot in the middle where the density has dramatically increased. My initial impression was that maybe it was lower income housing and many people have moved after the pandemic. After looking at Google maps it is a trailer park, which is unsurprising. In general, there is a net decrease in people per acre over North Fair Oaks. This could be due to increasing rents over the past decade and many people being discplaced. If wealthier families then move into those houses, they tend to have less children which could explain the results.  

```{r}
library(tidyverse)
library(sf)
library(censusapi)
library(mapview)
library(leaflet)
library(devtools)
install_github('walkerke/tigris')
library(tigris)
library(here)
library(dplyr)
```


```{r}
Sys.setenv(CENSUS_KEY="6b3fccc7aab7b5e8476641264fdd46337fb45dfe")

smc_pop_2020 <-
  getCensus(
    name = "dec/pl",
    vintage = 2020,
    region = "block:*", 
    regionin = "state:06+county:081",
    vars = "P1_001N"
  ) %>% 
  transmute(
    block =
      paste0(state,county,tract,block),
    pop = P1_001N
  )

```

<!-- # Collect 2010 decennial data -->

```{r}

smc_pop_2010 <-
  getCensus(
    name = "dec/pl",
    vintage = 2010,
    region = "block:*", 
    regionin = "state:06+county:081",
    vars = "P001001"
  ) %>% 
  transmute(
    block =
      paste0(state,county,tract,block),
    pop = P001001
  )

```


<!-- 2020 blocks -->
```{r}
smc_blocks_2020 <- blocks("CA", "San Mateo", year = 2020, progress_bar = F)
```

<!-- 2010 blocks -->
```{r}
smc_blocks_2010 <- blocks("CA", "San Mateo", year = 2010, progress_bar = F)
```

<!-- Shape file blocks for 2010 and nfo boundary -->

```{r}
   nfo_boundary <- places("CA", progress_bar = F) %>%
    filter(NAME == "North Fair Oaks")

 nfo_pop_2010 <- smc_pop_2010 %>%
   left_join(smc_blocks_2010 %>% select(block = GEOID10)) %>%
   st_as_sf() %>%
   st_centroid() %>%
   .[nfo_boundary, ] %>%
   st_drop_geometry() %>%
   left_join(smc_blocks_2010 %>% select(block = GEOID10)) %>%
   st_as_sf()
```

<!-- #Shape file blocks for 2010 -->
```{r}
place_blocks_2010 <- smc_pop_2010 %>% 
  left_join(smc_blocks_2010 %>% select(block = GEOID10)) %>% 
  st_as_sf() %>% 
  st_centroid() %>% 
  .[nfo_boundary, ] %>% 
  st_set_geometry(NULL) %>% 
  left_join(smc_blocks_2010 %>% select(block = GEOID10)) %>% 
  st_as_sf()
```
```{r}
place_blocks_2020 <- smc_pop_2020 %>% 
  left_join(smc_blocks_2020 %>% select(block = GEOID20)) %>% 
  st_as_sf() %>% 
  st_centroid() %>% 
  .[nfo_boundary, ] %>% 
  st_set_geometry(NULL) %>% 
  left_join(smc_blocks_2020 %>% select(block = GEOID20)) %>% 
  st_as_sf()
```

```{r}
smc_blocks_2020_intersect <- place_blocks_2020  %>%
  st_transform(26910) %>% 
  mutate(original_area = st_area(.)) %>% 
  st_intersection(
    place_blocks_2010 %>% 
      st_transform(26910)
  ) %>% 
  mutate(
    leftover_area = st_area(.),
    perc_area = as.numeric(leftover_area / original_area),
    pop_2020 = pop * perc_area
    )
```

```{r}
place_blocks_2020_reshaped <- smc_blocks_2020_intersect %>%
  st_drop_geometry() %>% 
  group_by(block.1) %>% 
  summarize(
    pop_2020 = sum(pop_2020, na.rm=T) %>% round()
  )
```


```{r}
place_blocks_2010 <- subset(place_blocks_2010, select = -c(geometry))
```

```{r}
place_blocks_2020_reshaped <-place_blocks_2020_reshaped %>%
  mutate(block = block.1) %>%
  select(-block.1)
```



```{r}
place_pop_2010_2020 <- place_blocks_2010 %>% 
  left_join(place_blocks_2020_reshaped)%>% 
  mutate(
    absolute_pop = (pop_2020 - pop) / as.numeric(st_area(.)) * 43560
  )
```
```{r}
max <- max(abs(place_pop_2010_2020$absolute_pop))
res_pal <- colorNumeric(
  palette = "PiYG",
  domain = 
    c(-max,max)
)
```




```{r}
leaflet(place_pop_2010_2020) %>% 
  addProviderTiles(provider = providers$CartoDB.Positron) %>% 
  addPolygons(
    fillColor = ~res_pal(absolute_pop),
    label = ~round(absolute_pop),
    color = "white",
    opacity = 0.5,
    fillOpacity = 0.75,
    weight = 1
  ) %>% 
  
  addLegend(
    pal = res_pal,
    value = c(-max,max),
    title = " Absolute Change in Density from 2010 to 2020 (people per acre)"
   
  )
```

