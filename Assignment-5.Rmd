---
title: "Sahil_A5"
output:
  html_document:
    df_print: paged
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning = F, message = F)
```


```{r}
library(tidyverse)
library(censusapi)
library(sf)
library(mapview)
library(tigris)
library(leaflet)
```


```{r}

library(readxl)

temp <- tempfile()
download.file("https://oehha.ca.gov/media/downloads/calenviroscreen/document/calenviroscreen40resultsdatadictionaryf2021.zip",destfile = temp)

ces4 <- read_excel(
  unzip(
    temp, 
    "calenviroscreen40resultsdatadictionary_F_2021.xlsx"
  ), 
  sheet = "CES4.0FINAL_results"
)

unlink(temp)
  
```

```{r}
bay_county_names <-
  c(
    "Alameda",
    "Contra Costa",
    "Marin",
    "Napa",
    "San Francisco",
    "San Mateo",
    "Santa Clara",
    "Solano",
    "Sonoma"
  )
ces4_bay <- ces4 %>%   
  filter(`California County` %in% bay_county_names)

ca_tracts <- tracts("CA", cb = T, progress_bar = F)

ces4_bay_pm25 <-
  ces4 %>% 
  filter(`California County` %in% bay_county_names) %>% 
  select(`Census Tract`, PM2.5) %>% 
  left_join(
    ca_tracts %>% 
      transmute(GEOID = as.numeric(GEOID)), 
    by = c("Census Tract" = "GEOID")
  ) %>% 
  st_as_sf()
```


```{r}
ces4_bay_asthma <-
  ces4 %>% 
  filter(`California County` %in% bay_county_names) %>% 
  select(`Census Tract`, Asthma) %>% 
  left_join(
    ca_tracts %>% 
      transmute(GEOID = as.numeric(GEOID)), 
    by = c("Census Tract" = "GEOID")
  ) %>% 
  st_as_sf()
```
Below is the concentration of PM2.5 in units of micrograms per meter cubed from 2015 to 2017. Higher concentrations are seen in Oakland and Vallejo. 

```{r}

pm25_pal <- colorNumeric(
  palette = "Reds",
  domain = ces4_bay_pm25$PM2.5
)

leaflet() %>% 
  addProviderTiles(providers$CartoDB.Positron) %>% 
  addPolygons(
    data = ces4_bay_pm25,
    fillColor = ~pm25_pal(PM2.5),
    color = "white",
    weight = 0.5,
    fillOpacity = 0.5,
    label = ~PM2.5
  )

```
Below is the age-adjusted rate of ED visits for asthma per
10,000 (averaged over 2015-2017). It appears that the most visits were in Vallejo and San Leandro area. 

```{r}
asthma_pal <- colorNumeric(
  palette = "Blues",
  domain = ces4_bay_asthma$Asthma
)

leaflet() %>% 
  addProviderTiles(providers$CartoDB.Positron) %>% 
  addPolygons(
    data = ces4_bay_asthma,
    fillColor = ~asthma_pal(Asthma),
    color = "white",
    weight = 0.5,
    fillOpacity = 0.5,
    label = ~Asthma
  )
```


<!-- # ```{r} -->
<!-- # ggplot() + -->
<!-- #   geom_point( -->
<!-- #     data = ces4_bay, -->
<!-- #     aes( -->
<!-- #       x = PM2.5, -->
<!-- #       y = Asthma -->
<!-- #     ) -->
<!-- #   ) -->
<!-- # ``` -->

The best fit of this regression is okay, however it looks like the data points are very squished.


```{r}
ggplot(
  data = ces4_bay,
  aes(
      x = PM2.5,
      y = Asthma
    )
) +
  geom_point() +
  geom_smooth(method = "lm")
```

Variation in PM2.5 explains 9.6% of the variation in Asthma. For every 1 increase in PM2.5, I predict a 116 increase in Asthma”

```{r}
 boom <- lm(Asthma ~ PM2.5, ces4_bay)
summary(boom)
```



<!-- # ```{r} -->
<!-- # slope <- 0 -->
<!-- # yintercept <- mean(ces4$PM2.5) -->
<!-- #  -->
<!-- # best_fit_candidate <- slope * ces4$Asthma + yintercept  -->
<!-- #  -->
<!-- # residuals <- ces4$PM2.5 - best_fit_candidate -->
<!-- #  -->
<!-- # sumsq_residuals <- sum(residuals^2) -->
<!-- #  -->
<!-- # sumsq_residuals -->
<!-- # ``` -->

<!-- # ```{r} -->
<!-- # ggplot( -->
<!-- #   data = ces4, -->
<!-- #   aes( -->
<!-- #       x = Asthma, -->
<!-- #       y = PM2.5 -->
<!-- #     ) -->
<!-- # ) + -->
<!-- #   geom_point() + -->
<!-- #   geom_smooth(method = "lm") + -->
<!-- #   geom_line( -->
<!-- #     aes( -->
<!-- #       x = ces4$Asthma, -->
<!-- #       y = best_fit_candidate -->
<!-- #     ), -->
<!-- #     color = "red", -->
<!-- #     size = 1 -->
<!-- #   ) -->
<!-- # ``` -->





From the textbook, "regression models are only valid if a set of conditions are true about the data, including that the mean of the residuals is ~ 0, and that the residuals are normally distributed." Here the residuals are very much not centered at 0.
<!-- # ```{r} -->
<!-- # model <- lm(  Asthma ~ PM2.5, ces4) -->
<!-- # plot(density(residuals(model))) -->
<!-- # ``` -->


<!-- Log the data  -->




```{r}
 model <- lm(Asthma ~ PM2.5, ces4_bay)
 plot(density(residuals(model)))

```

Here the data looks a little more symmetrical and the best fit line looks like it accurately represents the data points. 

```{r}
ggplot(
  data = ces4_bay,
  aes(
      x = PM2.5,
      y = log(Asthma)
    )
) +
  geom_point() +
  geom_smooth(method = "lm")
```

Variation in PM2.5 explains 10% of the variation in Asthma. For every 1 increase in PM2.5, I predict a doubling of Asthma”

```{r}
 bboom <- lm(log(Asthma) ~ PM2.5, ces4_bay)
summary(bboom)
```


```{r}


#residuals_spatial$residuals  <- log_model$residuals

ca_tracts <- tracts("CA", cb = T, progress_bar = F)

ces4_bay <-
 ces4 %>% 
  left_join(
    ca_tracts %>% 
      transmute(`Census Tract`= as.numeric(GEOID))
    #by = c("Census Tract" = "GEOID")
  ) %>%
  filter(`California County` %in% bay_county_names) %>% 
  st_as_sf()
```
The residuals are more normally distributed and we can see that this log transformation is better suited towards the data. 

```{r}
log_model <- lm(log(Asthma) ~ PM2.5, ces4_bay)
plot(density(residuals(log_model)))

```

```{r}

ces4_bay_residuals <- ces4_bay %>% 
  filter(!is.na(PM2.5),
         !is.na(Asthma)) %>% 
  mutate(residuals = residuals(log_model))

```


A negative residual in the context of Asthma estimation means that the actual value was less than the predicted value, so the person is doing better with Asthma than predicted. The region with the most negative residual is Stanford. I think this is the case because we are only using a 3 year sample and are predicting a high number of diverse students with varying health concerns having issues. This is not really the case, exacerbated by the fact that students tend to graduate and move out fairly frequently.  

```{r}
pm25_pal <- colorNumeric(
  palette = "Reds",
  domain = ces4_bay_residuals$residuals
)

leaflet() %>% 
  addProviderTiles(providers$CartoDB.Positron) %>% 
  addPolygons(
    data = ces4_bay_residuals,
    fillColor = ~pm25_pal(residuals),
    color = "white",
    weight = 0.5,
    fillOpacity = 0.5,
    label = ~residuals
  )

```